<!-- Popup modal table for couriers in selected date range -->
<div *ngIf="showDateRangeResults" class="modal">
  <div class="modal-content">
    <button (click)="closeDateRangeModal()">Close</button>
    <h3>Couriers in Selected Date Range</h3>
    <table>
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Courier ID</th>
          <th>Status</th>
          <th>Date</th>
          <th>Estimate Date</th>
          <th>Destination</th>
          <th>Company ID</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let courier of dateRangeResults">
          <td>{{ courier.orderId }}</td>
          <td>{{ courier.courierId }}</td>
          <td>{{ courier.status }}</td>
          <td>{{ courier.date | date }}</td>
          <td>{{ courier.estimateDate | date }}</td>
          <td>{{ courier.destination }}</td>
          <td>{{ courier.companyId }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<div class="courier-container">
    <!-- Page Title -->
    <div class="section-title">
      <h2><b>Courier Summary</b></h2>
    </div>

    <!-- Loading spinner -->
    <div class="loading-indicator" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Loading data...</p>
    </div>

    <!-- Error message -->
    <div class="error-message" *ngIf="hasError">
      <p><i class="material-icons">error</i> {{errorMessage}}</p>
      <button (click)="loadData()">Try Again</button>
    </div>

    <div *ngIf="!isLoading && !hasError">
      <!-- Filter Inputs: Search and Date Range -->
      <div class="filters-row">
        <div class="search-container">
          <!-- Search input for courier or order ID -->
          <input type="text" placeholder="Search anything..." [(ngModel)]="searchTerm" (keyup.enter)="searchDeliveries()" />
          <!-- Trigger search manually -->
          <button class="search-btn" (click)="searchDeliveries()">
            <span class="material-icons">search</span>
          </button>
        </div>

        <!-- Date filter inputs -->
        <div class="date-range">
          <div class="date-input">
            <label>From : </label>
            <input type="date" [(ngModel)]="fromDate" (change)="fetchSummary(); ensureChartVisible()" />
          </div>
          <div class="date-input">
            <label>To : </label>
            <input type="date" [(ngModel)]="toDate" (change)="fetchSummary(); ensureChartVisible()" />
          </div>
        </div>
      </div>

      <div>
        <!-- Button to show popup table for selected date range -->
         <button (click)="loadCouriersForDateRange(); ensureChartVisible()">Show Couriers in Date Range</button>
        </div>

      <!-- Delivery summary stats and pie chart -->
      <div class="summary-section">
        <div class="delivery-stats">
          <!-- Total deliveries -->
          <div class="stat-row total-row">
            <span class="stat-label"><b>Total Deliveries</b></span>
            <span class="stat-value">: {{summary.total || 0}}</span>
          </div>
          <div class="stat-divider"></div>

          <!-- Breakdown by status -->
          <div class="stat-row">
            <span class="stat-label">Pending Deliveries</span>
            <span class="stat-value">: {{summary.pending || 0}}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Completed Deliveries</span>
            <span class="stat-value">: {{summary.completed || 0}}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Rejected Deliveries</span>
            <span class="stat-value">: {{summary.rejected || 0}}</span>
          </div>
        </div>

        <!-- Pie chart for delivery status -->
        <div class="pie-chart">
          <div *ngIf="isLoading" class="chart-loading">
            <div class="spinner"></div>
            <p>Loading chart...</p>
          </div>
          <div *ngIf="noDataAvailable" class="chart-no-data">
            <p>No delivery data available for the selected time range</p>
          </div>
          <div *ngIf="!isLoading && !noDataAvailable" class="chart-with-legend">
            <div class="chart-container">
              <canvas #deliveryPieChart width="200" height="200"></canvas>
            </div>
            <div class="chart-custom-legend">
              <div class="legend-item">
                <span class="legend-color pending"></span>
                <span class="legend-text">Pending: {{summary.pending || 0}}</span>
              </div>
              <div class="legend-item">
                <span class="legend-color completed"></span>
                <span class="legend-text">Completed: {{summary.completed || 0}}</span>
              </div>
              <div class="legend-item">
                <span class="legend-color rejected"></span>
                <span class="legend-text">Rejected: {{summary.rejected || 0}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- List of recent deliveries in table format -->
      <div class="recent-deliveries">
        <h3>Recent Deliveries</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Delivery ID</th>
                <th>Order ID</th>
                <th>Order Date</th>
                <th>Estimated to</th>
                <th>City</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let delivery of recentDeliveries">
                <td>{{delivery?.courierId || 'N/A'}}</td>
                <td>{{delivery?.orderId || 'N/A'}}</td>
                <td>{{delivery?.date ? (delivery.date | date:'dd/MM/yyyy') : 'N/A'}}</td>
                <td>{{delivery?.estimateDate ? (delivery.estimateDate | date:'dd/MM/yyyy') : 'N/A'}}</td>
                <td>{{delivery?.destination || 'N/A'}}</td>
                <td>
                  <span class="status" [ngClass]="getStatusClass(delivery?.status)">
                    {{delivery?.status || 'N/A'}}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="no-data-message" *ngIf="recentDeliveries.length === 0">
            No courier data available for the selected period.
          </div>
        </div>
      </div>

      <!-- Button to print summary report -->
      <div class="print-report">
        <button (click)="printReport()">
          Print Report
          <span class="material-icons">print</span>
        </button>
      </div>
    </div>

    <!-- Search results modal popup -->
    <div class="modal-overlay" *ngIf="showSearchResults" (click)="closeSearchModal($event)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Search Results</h3>
          <button class="close-button" (click)="closeSearchModal()">×</button>
        </div>
        <div class="modal-body">
          <div *ngIf="searchResults.length === 0" class="no-results">
            No couriers found matching "{{searchTerm}}".
          </div>
          <div *ngIf="searchResults.length > 0" class="search-results-table">
            <table>
              <thead>
                <tr>
                  <th>Delivery ID</th>
                  <th>Order ID</th>
                  <th>Date</th>
                  <th>Destination</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let result of searchResults" (click)="selectCourier(result)" class="selectable-row">
                  <td>{{result?.courierId || 'N/A'}}</td>
                  <td>{{result?.orderId || 'N/A'}}</td>
                  <td>{{ result?.date ? (result.date | date:'dd/MM/yyyy') : 'N/A' }}</td>
                  <td>{{result?.destination || 'N/A'}}</td>
                  <td>
                    <span class="status" [ngClass]="getStatusClass(result?.status)">
                      {{result?.status || 'N/A'}}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Date range results modal popup (single, full details) -->
    <div class="modal-overlay" *ngIf="showDateRangeResults" (click)="closeDateRangeModal($event)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Date Range Results</h3>
          <button class="close-button" (click)="closeDateRangeModal(); ensureChartVisible()">×</button>
        </div>
        <div class="modal-body">
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Courier ID</th>
                <th>Status</th>
                <th>Date</th>
                <th>Estimate Date</th>
                <th>Destination</th>
                <th>Company ID</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let courier of dateRangeResults">
                <td>{{ courier.orderId }}</td>
                <td>{{ courier.courierId }}</td>
                <td>{{ courier.status }}</td>
                <td>{{ courier.date | date }}</td>
                <td>{{ courier.estimateDate | date }}</td>
                <td>{{ courier.destination }}</td>
                <td>{{ courier.companyId }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

